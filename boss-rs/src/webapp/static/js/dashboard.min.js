'use strict';var angular=window.angular,CREX=CREX||{};CREX.slingshot=CREX.slingshot||{};CREX.slingshot.controlPanel=CREX.slingshot.controlPanel||{};
CREX.slingshot.controlPanel.app=angular.module("controlPanel",["angularMoment"],["$routeProvider","$locationProvider",function(b,c){b.when("/",{redirectTo:"/accounts"}).when("/account/:accountId/templates",{templateUrl:"../static/partials/template-picker.html",controller:"TemplateSelection"}).when("/accounts",{templateUrl:"../static/partials/account-picker.html",controller:"AccountSelection"}).when("/revisions/:accountId",{templateUrl:"../static/partials/revisions.html",controller:"Revisions"}).otherwise({redirectTo:"/"})}]);CREX.slingshot.controlPanel.app.controller("Main",["$scope","$rootScope","$route","$routeParams","$location","$window","ServerCommunication",function(b,c,f,d,a,e,g){b.account=null;b.accounts=[];g.getAccounts().success(function(c,e,d,f){b.accounts=c;var k=a.host();angular.forEach(b.accounts,function(a){a.publishTime&&(a.accountSiteUrl="//"+a.accountId+"."+k)})});b.settings={};c.importTimers={};c.uploadTimers=[]}]);CREX.slingshot.controlPanel.app.controller("Revisions",["$scope","$rootScope","$route","$location","ServerCommunication","$compile","$window","Analytics",function(b,c,f,d,a,e,g,m){function n(a){angular.forEach(a,function(a){k[a.id]||(k[a.id]=a,a.timestamp&&(a.when=new Date(a.timestamp)))});b.revArray=[];angular.forEach(k,function(a){var c=k[a.parentId],e=a.parents=a.parents||[];c&&(c.children=c.children||[],~c.children.indexOf(a)||c.children.push(a),~e.indexOf(c)||e.push(c));b.revArray.push(a)});
var c=[];angular.forEach(k,function(a){a.parents.length||c.push(a)});return 1<c.length?{children:c,__pseudo:!0}:c[0]}function h(){p||(p=!0,a.getRevisions(f.current.params.accountId,q,r).success(function(a,c,e,d){c=a.length;q+=c;n(a);b.loading=!1;c>=r&&document.documentElement.scrollHeight<=document.documentElement.clientHeight&&setTimeout(h,250);p=!1}).error(function(){window.console.error("error loading revisions",arguments);p=!1}))}m.sendEvent("revisions","view","??",f.current.params.accountId);
b.loading=!0;var l=angular.element("#revision-change-modal");b.changeSiteToRev=function(c){if(c){if(!window.confirm("Revert site back to revision "+c+"?"))return!1;b.changeError=!1;l.modal({});a.moveToRevision(f.current.params.accountId,c).success(function(){l.on("hidden.bs.modal",function(){g.location.href="/builder"}).modal("hide")}).error(function(){b.changeError=!0})}};b.changeSiteToFocusedRev=function(){b.focusRev&&b.changeSiteToRev(b.focusRev.id)};var k={};(function(){if(!window.moment){var a=
angular.element('<script src="/static/js/moment.min.js">\x3c/script>'),c=!0;angular.forEach(angular.element("script"),function(b){a.src===b.src&&(c=!1)});c&&angular.element(document.body).append(a)}})();var p=!1,q=0,r=10;h();b.handleScroll=function(){var a=document.documentElement;200>Math.abs(a.scrollHeight-window.scrollY-a.clientHeight)&&h()};angular.element(window).bind("scroll",b.handleScroll);b.$on("$destroy",function(){return angular.element(window).off("scroll",b.handleScroll)})}]);CREX.slingshot.controlPanel.app.controller("TemplateSelection",["$scope","$rootScope","$route","$location","ServerCommunication","$timeout","$window","Analytics",function(b,c,f,d,a,e,g,m){var n=0;b.importError=!1;b.$watch("$route.current.params.accountId",function(c){(c=f.current.params.accountId)&&a.getTemplates(c).success(function(c,e,f,h){var g={host:d.host(),port:d.port()};g.port=80===g.port?"":":"+g.port;c.forEach(function(c){var b=angular.extend(g,c);c.url=a.fillString("//:name.:host:port/",
b);c.previewUrl=a.fillString("//:name.:host:port/preview.png",b)});b.templates=c})});b.importTemplate=function(d,l){var k=l.id;d.stopPropogation&&d.stopPropogation();d.preventDefault&&d.preventDefault();m.sendEvent("importTemplate","askOverwrite",l.name,k);if(!confirm("Overwrite current site, all contents of your existing site will be erased!"))return m.sendEvent("importTemplate","declineOverwrite",l.name,k),!1;b.importError=!1;angular.element("#template-import-modal").modal();m.sendEvent("importTemplate",
"confirmOverwrite",l.name,k);var p=function(){if(c.importTimers[k].requestCameBack){var d=!1;99<((c.importTimers[k].data||{}).import||{}).progress&&(d=!0);if(d){angular.element("#template-import-modal").on("hidden.bs.modal",function(){g.location.href="/builder"}).modal("hide");return}c.importTimers[k].requestCameBack=!1;c.importTimers[k].request=a.getTemplateImportProgress(f.current.params.accountId,k).success(function(a,b,d,e){c.importTimers[k].data=a;c.importTimers[k].requestCameBack=!0}).error(function(a,
d,f,g){e.cancel(c.importTimers[k].timer);b.importError=!0})}c.importTimers[k].timer=e(p,950)};c.importTimers[k]={request:null,data:null,requestCameBack:!0,timer:null};a.importSelectedTemplate(f.current.params.accountId,k).success(function(a,b,d,f){c.importTimers[k].timer=e(p,250)}).error(function(a,c,b,d){})};b.previewTemplate=function(a,c){m.sendEvent("previewTemplate","openInNewWindow",c.name,++n)}}]);CREX.slingshot.controlPanel.app.controller("AccountSelection",["$scope","$location","ServerCommunication",function(b,c,f){b.setBuilderAccountId=function(a){b.$parent.account=a;window.localStorage.setItem("builderAccountId",a.accountId)};var d=!1;b.$watch("accounts.length",function(){b.accounts&&(b.accounts&&1===b.accounts.length&&!b.accounts[0].currentTemplate&&!d)&&(c.path(f.fillString("/account/:accountId/templates",{accountId:b.accounts[0].accountId})),d=!0)})}]);CREX.slingshot.controlPanel.app.directive("templateExternal",["$rootScope","$route","$window","$timeout","ServerCommunication",function(b,c,f,d,a){return{restrict:"E",templateUrl:"/static/partials/templateExternal.html",replace:!0,link:function(e,g,m){g.find("button").on("click",function(){var e=g.find("#externalSiteUrl").val();if(!confirm("Overwrite current site and import template?"))return!1;angular.element("#template-import-modal").modal();var h={request:null,data:null,requestCameBack:!0,timer:null};
b.uploadTimers.push(h);var l=function(){if(h.requestCameBack){var b=!1;99<((h.data||{}).upload||{}).progress&&(b=!0);if(b){angular.element("#template-import-modal").on("hidden.bs.modal",function(){f.location.href="/builder"}).modal("hide");return}h.requestCameBack=!1;h=a.getExternalTemplateImportProgress(c.current.params.accountId).success(function(a,c,b,d){h.data=a;h.requestCameBack=!0}).error(function(a,c,b,e){d.cancel(h.timer);angular.element("#template-import-modal").modal("hide");alert("There was an error importing the url.")})}h.timer=
d(l,950)};a.importExternalTemplate(c.current.params.accountId,e).success(function(a,c,b,e){h.timer=d(l,250)}).error(function(a,c,b,d){angular.element("#template-import-modal").modal("hide");alert("There was an error uploading the template.")})})}}}]);CREX.slingshot.controlPanel.app.directive("templateUpload",["$rootScope","$route","$window","$timeout","ServerCommunication",function(b,c,f,d,a){return{restrict:"E",templateUrl:"/static/partials/templateUpload.html",replace:!0,link:function(e,g,m){g.find("button").bind("click",function(){var e=g.find("input")[0].files;if(1>e.length)alert("Please select a ZIP format file for template upload.");else if(e=e[0],e.name.match(/\.zip$/)){if(!confirm("Overwrite current site and import template?"))return!1;
angular.element("#template-import-modal").modal();var h={request:null,data:null,requestCameBack:!0,timer:null};b.uploadTimers.push(h);var l=function(){if(h.requestCameBack){var b=!1;99<((h.data||{}).upload||{}).progress&&(b=!0);if(b){angular.element("#template-import-modal").on("hidden.bs.modal",function(){f.location.href="/builder"}).modal("hide");return}h.requestCameBack=!1;h=a.getTemplateUploadProgress(c.current.params.accountId).success(function(a,c,b,e){h.data=a;h.requestCameBack=!0}).error(function(a,
c,b,e){d.cancel(h.timer);angular.element("#template-import-modal").modal("hide");alert("There was an error importing the template.")})}h.timer=d(l,950)};a.uploadTemplate(c.current.params.accountId,e).success(function(a,c,b,e){h.timer=d(l,250)}).error(function(a,c,b,e){angular.element("#template-import-modal").modal("hide");alert("There was an error uploading the template.")})}else alert("Please use ZIP format file for template upload.")})}}}]);(function(){function b(c,b,d){c&&b&&(c.tz?c=c.tz(b):d.warn("angular-moment: timezone specified but moment.tz() is undefined. Did you forget to include moment-timezone.js?"));return c}angular.module("angularMoment",[]).constant("angularMomentConfig",{timezone:""}).constant("amTimeAgoConfig",{withoutSuffix:!1}).directive("amTimeAgo",["$window","amTimeAgoConfig",function(c,b){return function(d,a,e){function g(){h&&(c.clearTimeout(h),h=null)}function m(b){a.text(b.fromNow(p));var e=c.moment().diff(b,
"minute"),d=3600;1>e?d=1:60>e?d=30:180>e&&(d=300);h=c.setTimeout(function(){m(b)},1E3*d)}function n(){g();m(c.moment(l,k))}var h=null,l,k,p=b.withoutSuffix;d.$watch(e.amTimeAgo,function(b){"undefined"===typeof b||null===b||""===b?(g(),l&&(a.text(""),l=null)):(angular.isNumber(b)&&(b=new Date(b)),l=b,n())});angular.isDefined(e.amWithoutSuffix)&&d.$watch(e.amWithoutSuffix,function(a){"boolean"===typeof a?(p=a,n()):p=b.withoutSuffix});e.$observe("amFormat",function(a){k=a;l&&n()});d.$on("$destroy",function(){g()});
d.$on("amMoment:languageChange",function(){n()})}}]).factory("amMoment",["$window","$rootScope",function(b,f){return{changeLanguage:function(d){var a=b.moment.lang(d);angular.isDefined(d)&&f.$broadcast("amMoment:languageChange");return a}}}]).filter("amCalendar",["$window","$log","angularMomentConfig",function(c,f,d){return function(a){if("undefined"===typeof a||null===a)return"";!isNaN(parseFloat(a))&&isFinite(a)&&(a=new Date(parseInt(a,10)));a=c.moment(a);return a.isValid()?b(a,d.timezone,f).calendar():
""}}]).filter("amDateFormat",["$window","$log","angularMomentConfig",function(c,f,d){return function(a,e){if("undefined"===typeof a||null===a)return"";!isNaN(parseFloat(a))&&isFinite(a)&&(a=new Date(parseInt(a,10)));var g=c.moment(a);return g.isValid()?b(g,d.timezone,f).format(e):""}}]).filter("amDurationFormat",["$window",function(b){return function(f,d,a){return"undefined"===typeof f||null===f?"":b.moment.duration(f,d).humanize(a)}}])})();CREX.slingshot.controlPanel.app.factory("Analytics",function(){return{sendEvent:function(b,c,f,d,a){try{var e=[];[].push.apply(e,arguments);e.unshift("send","event");window.ga.apply(window,e)}catch(g){window.console&&window.console.error("error sending event",g&&(g.message||g.messages),g)}}}});CREX.slingshot.controlPanel.app.factory("ServerCommunication",["$http","$window",function(b,c){var f=function(a,b,d,f){401===b&&(c.location.href="/login")},d=function(a,b){if(!a||!b||"string"!==typeof a||"object"!==typeof b)return!1;for(var c in b)b.hasOwnProperty(c)&&(a=a.replace(RegExp(":"+c,"g"),b[c]));return a};return{fillString:d,getAccounts:function(){return b.get("/api/0.2/user/accounts").error(f)},getTemplates:function(a){if(a)return b.get("/api/0.2/"+d("account/:accountId/templates",{accountId:a})).error(f)},
getSelectedTemplate:function(a){if(a)return b.get("/api/0.2/"+d("account/:accountId/templates/selected",{accountId:a})).error(f)},uploadTemplate:function(a,c){if(a&&c){var g=new FormData;g.append("uploadfile",c);g.append("data",angular.toJson({name:c.name}));return b({method:"POST",url:"/api/0.2/"+d("account/:accountId/templates/template/external/upload",{accountId:a}),data:g,headers:{"Content-Type":void 0},transformRequest:angular.identity}).error(f)}},getTemplateUploadProgress:function(a){if(a)return b.get("/api/0.2/"+
d("account/:accountId/templates/template/external/upload",{accountId:a})).error(f)},importSelectedTemplate:function(a,c){if(a&&c)return b.post("/api/0.2/"+d("account/:accountId/templates/template/:templateId/import",{accountId:a,templateId:c})).error(f)},getTemplateImportProgress:function(a,c){if(a&&c)return b.get("/api/0.2/"+d("account/:accountId/templates/template/:templateId/import",{accountId:a,templateId:c})).error(f)},importExternalTemplate:function(a,c){if(a&&c)return b({method:"POST",url:"/api/0.2/"+
d("account/:accountId/templates/template/external/import",{accountId:a}),data:angular.toJson({url:c})}).error(f)},getExternalTemplateImportProgress:function(a){if(a)return b.get("/api/0.2/"+d("account/:accountId/templates/template/external/import",{accountId:a})).error(f)},getRevisions:function(a,c,g){if(a){var m=[],n="account/:accountId/revision";g&&m.push("maxCount=:maxCount");c&&m.push("skip=:skip");m.length&&(n+="?"+m.join("&"));return b.get("/api/0.2/"+d(n,{accountId:a,skip:c,maxCount:g})).error(f)}},
moveToRevision:function(a,c){if(a&&c)return b({method:"POST",url:"/api/0.2/"+d("account/:accountId/revision/:revisionId",{accountId:a,revisionId:c})}).error(f)}}}]);


// (1395779909890)

//# sourceMappingURL=/static/js/dashboard.min.js.map